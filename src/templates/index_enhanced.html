<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElectroML - Advanced Electrochemical Data Analysis</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/style_enhanced.css') }}" rel="stylesheet">
    <!-- Tooltip CSS -->
    <link href="{{ url_for('static', filename='css/tooltips.css') }}" rel="stylesheet">
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-flask"></i> ElectroML v2.1
            </a>
            <span class="navbar-text text-white">
                Professional Machine Learning Platform for Electrochemical Analysis
            </span>
            <button class="btn btn-light btn-sm ms-auto" onclick="showHelp()">
                <i class="fas fa-question-circle"></i> Help
            </button>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container-fluid mt-3">
        <div class="row">
            <!-- Enhanced Sidebar -->
            <div class="col-md-2">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0">Analysis Workflow
                            <span class="electroml-tooltip">
                                <span class="tooltip-icon">?</span>
                                <span class="tooltiptext">
                                    <div class="tooltip-header">ML Pipeline for Electrochemistry</div>
                                    <div>Systematic workflow converting voltammetric data to concentration predictions:</div>
                                    <ul class="tooltip-list">
                                        <li>Upload: Import CV/DPV data</li>
                                        <li>Preprocess: Denoise & baseline correction</li>
                                        <li>Extract: Convert to ML features</li>
                                        <li>Train: Build predictive models</li>
                                        <li>Predict: Analyze unknowns</li>
                                    </ul>
                                </span>
                            </span>
                        </h6>
                    </div>
                    <div class="card-body p-2">
                        <div class="workflow-steps">
                            <div class="step active" id="step-1">
                                <i class="fas fa-upload"></i> Data Upload
                            </div>
                            <div class="step" id="step-2">
                                <i class="fas fa-filter"></i> Preprocessing
                            </div>
                            <div class="step" id="step-3">
                                <i class="fas fa-cogs"></i> Feature Extraction
                            </div>
                            <div class="step" id="step-4">
                                <i class="fas fa-brain"></i> Model Training
                            </div>
                            <div class="step" id="step-5">
                                <i class="fas fa-chart-line"></i> Prediction
                            </div>
                            <div class="step" id="step-6">
                                <i class="fas fa-image"></i> Visualization
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Session Info -->
                <div class="card mt-3">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">Session Info</h6>
                    </div>
                    <div class="card-body p-2" id="session-info">
                        <small>
                            <div>Session: <span id="session-id">N/A</span></div>
                            <div>Data: <span id="data-status">Not loaded</span></div>
                            <div>Models: <span id="models-count">0</span></div>
                        </small>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="col-md-10">
                <!-- Enhanced Tab Navigation -->
                <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" 
                                data-bs-target="#upload" type="button">
                            <i class="fas fa-upload"></i> Data Upload
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="preprocessing-tab" data-bs-toggle="tab" 
                                data-bs-target="#preprocessing" type="button" disabled>
                            <i class="fas fa-filter"></i> Preprocessing
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="features-tab" data-bs-toggle="tab" 
                                data-bs-target="#features" type="button" disabled>
                            <i class="fas fa-cogs"></i> Features
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="training-tab" data-bs-toggle="tab" 
                                data-bs-target="#training" type="button" disabled>
                            <i class="fas fa-brain"></i> Training
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="prediction-tab" data-bs-toggle="tab" 
                                data-bs-target="#prediction" type="button" disabled>
                            <i class="fas fa-chart-line"></i> Prediction
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="visualization-tab" data-bs-toggle="tab" 
                                data-bs-target="#visualization" type="button" disabled>
                            <i class="fas fa-image"></i> Visualization
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="mainTabContent">
                    
                    <!-- Data Upload Tab -->
                    <div class="tab-pane fade show active" id="upload" role="tabpanel">
                        <div class="card mt-3">
                            <div class="card-body">
                                <h5 class="card-title">Data Upload
                                    <span class="electroml-tooltip">
                                        <span class="tooltip-icon important">?</span>
                                        <span class="tooltiptext">
                                            <div class="tooltip-header">Electrochemical Data Format</div>
                                            <div>Upload your voltammetric data in Excel/CSV format:</div>
                                            <ul class="tooltip-list">
                                                <li>Column 1: Concentration (Î¼M)</li>
                                                <li>Columns 2+: Current at each voltage</li>
                                            </ul>
                                            <div class="tooltip-formula">Standard: -1V to +1V (0.005V steps)</div>
                                            <div class="tooltip-example">Supports CV, DPV, SWV, LSV data</div>
                                        </span>
                                    </span>
                                </h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div id="dropZone" class="drop-zone">
                                            <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                                            <p>Drag & drop your data file here or click to browse</p>
                                            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" hidden>
                                            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                                                Select File
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div id="dataPreview" style="display: none;">
                                            <h6>Data Preview</h6>
                                            <table class="table table-sm">
                                                <tbody>
                                                    <tr><td>File:</td><td id="fileName"></td></tr>
                                                    <tr><td>Samples:</td><td id="nSamples"></td></tr>
                                                    <tr><td>Features:</td><td id="nFeatures"></td></tr>
                                                    <tr><td>Concentration Range:</td><td id="concRange"></td></tr>
                                                </tbody>
                                            </table>
                                            <button class="btn btn-success" onclick="proceedToPreprocessing()">
                                                Proceed to Preprocessing <i class="fas fa-arrow-right"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Preprocessing Tab -->
                    <div class="tab-pane fade" id="preprocessing" role="tabpanel">
                        <div class="card mt-3">
                            <div class="card-body">
                                <h5 class="card-title">Data Preprocessing
                                    <span class="electroml-tooltip">
                                        <span class="tooltip-icon important">?</span>
                                        <span class="tooltiptext">
                                            <div class="tooltip-header">Signal Enhancement</div>
                                            <div>Preprocessing improves ML accuracy by 20-40% through:</div>
                                            <ul class="tooltip-list">
                                                <li>Noise reduction (filtering)</li>
                                                <li>Baseline drift correction</li>
                                                <li>Outlier removal</li>
                                                <li>Signal normalization</li>
                                            </ul>
                                            <div class="tooltip-emphasis">Similar to data treatment in spectroscopy!</div>
                                        </span>
                                    </span>
                                </h5>
                                
                                <div class="row">
                                    <!-- Outlier Removal -->
                                    <div class="col-md-3">
                                        <h6>Outlier Removal
                                            <span class="electroml-tooltip">
                                                <span class="tooltip-icon">?</span>
                                                <span class="tooltiptext">
                                                    <div class="tooltip-header">Remove Anomalous Data</div>
                                                    <div>Identifies and removes spurious measurements:</div>
                                                    <ul class="tooltip-list">
                                                        <li><strong>IQR:</strong> Statistical method using quartiles</li>
                                                        <li><strong>Z-Score:</strong> >3Ï from mean</li>
                                                        <li><strong>Isolation Forest:</strong> ML-based detection</li>
                                                    </ul>
                                                    <div class="tooltip-example">Removes electrode fouling artifacts</div>
                                                </span>
                                            </span>
                                        </h6>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="removeOutliers">
                                            <label class="form-check-label" for="removeOutliers">
                                                Remove Outliers
                                            </label>
                                        </div>
                                        <select class="form-select form-select-sm mt-2" id="outlierMethod">
                                            <option value="iqr">IQR Method</option>
                                            <option value="zscore">Z-Score</option>
                                            <option value="isolation_forest">Isolation Forest</option>
                                        </select>
                                        <input type="number" class="form-control form-control-sm mt-2" 
                                               id="outlierThreshold" placeholder="Threshold" value="3">
                                    </div>
                                    
                                    <!-- Baseline Correction -->
                                    <div class="col-md-3">
                                        <h6>Baseline Correction
                                            <span class="electroml-tooltip">
                                                <span class="tooltip-icon">?</span>
                                                <span class="tooltiptext">
                                                    <div class="tooltip-header">Remove Background Current</div>
                                                    <div>Subtracts capacitive/background current:</div>
                                                    <ul class="tooltip-list">
                                                        <li><strong>Polynomial:</strong> Fits curve to baseline</li>
                                                        <li><strong>ALS:</strong> Asymmetric least squares for CV</li>
                                                        <li><strong>Moving Avg:</strong> Simple rolling baseline</li>
                                                    </ul>
                                                    <div class="tooltip-formula">i_faradaic = i_total - i_capacitive</div>
                                                </span>
                                            </span>
                                        </h6>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="baselineCorrection">
                                            <label class="form-check-label" for="baselineCorrection">
                                                Apply Baseline Correction
                                            </label>
                                        </div>
                                        <select class="form-select form-select-sm mt-2" id="baselineMethod">
                                            <option value="polynomial">Polynomial</option>
                                            <option value="als">Asymmetric LS</option>
                                            <option value="moving_average">Moving Average</option>
                                        </select>
                                        <input type="number" class="form-control form-control-sm mt-2" 
                                               id="polyOrder" placeholder="Poly Order" value="3">
                                    </div>
                                    
                                    <!-- Signal Filtering -->
                                    <div class="col-md-3">
                                        <h6>Signal Filtering
                                            <span class="electroml-tooltip">
                                                <span class="tooltip-icon">?</span>
                                                <span class="tooltiptext">
                                                    <div class="tooltip-header">Noise Reduction</div>
                                                    <div>Reduces electrical noise while preserving peaks:</div>
                                                    <ul class="tooltip-list">
                                                        <li><strong>Savitzky-Golay:</strong> Preserves peak shape</li>
                                                        <li><strong>Butterworth:</strong> Frequency filtering</li>
                                                        <li><strong>Median:</strong> Removes spike noise</li>
                                                    </ul>
                                                    <div class="tooltip-emphasis">Window=11 typical for voltammetry</div>
                                                </span>
                                            </span>
                                        </h6>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="applyFilter">
                                            <label class="form-check-label" for="applyFilter">
                                                Apply Filter
                                            </label>
                                        </div>
                                        <select class="form-select form-select-sm mt-2" id="filterType">
                                            <option value="savgol">Savitzky-Golay</option>
                                            <option value="butterworth">Butterworth</option>
                                            <option value="chebyshev">Chebyshev</option>
                                            <option value="median">Median</option>
                                        </select>
                                        <input type="number" class="form-control form-control-sm mt-2" 
                                               id="filterWindow" placeholder="Window" value="11">
                                    </div>
                                    
                                    <!-- Normalization -->
                                    <div class="col-md-3">
                                        <h6>Normalization
                                            <span class="electroml-tooltip">
                                                <span class="tooltip-icon">?</span>
                                                <span class="tooltiptext">
                                                    <div class="tooltip-header">Scale Data for ML</div>
                                                    <div>Standardizes feature ranges for algorithms:</div>
                                                    <ul class="tooltip-list">
                                                        <li><strong>Min-Max:</strong> Scales to [0,1]</li>
                                                        <li><strong>Z-Score:</strong> Mean=0, StdDev=1</li>
                                                        <li><strong>Robust:</strong> Median-based, outlier resistant</li>
                                                    </ul>
                                                    <div class="tooltip-emphasis">Essential for SVM & Neural Networks!</div>
                                                </span>
                                            </span>
                                        </h6>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="normalize">
                                            <label class="form-check-label" for="normalize">
                                                Normalize Data
                                            </label>
                                        </div>
                                        <select class="form-select form-select-sm mt-2" id="normMethod">
                                            <option value="minmax">Min-Max</option>
                                            <option value="zscore">Z-Score</option>
                                            <option value="robust">Robust</option>
                                        </select>
                                        <div class="form-check mt-2">
                                            <input class="form-check-input" type="checkbox" id="computeDerivative">
                                            <label class="form-check-label" for="computeDerivative">
                                                Compute Derivatives
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <button class="btn btn-primary" onclick="applyPreprocessing()">
                                            <i class="fas fa-play"></i> Apply Preprocessing
                                        </button>
                                        <button class="btn btn-secondary" onclick="detectPeaks()">
                                            <i class="fas fa-mountain"></i> Detect Peaks
                                        </button>
                                        <button class="btn btn-info" onclick="selectVoltageRange()">
                                            <i class="fas fa-crop"></i> Select Voltage Range
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="preprocessingResults" class="mt-3" style="display: none;">
                                    <div class="alert alert-success">
                                        <h6>Preprocessing Complete</h6>
                                        <div id="preprocessingSteps"></div>
                                        <button class="btn btn-success mt-3" onclick="proceedToFeatures()">
                                            Proceed to Feature Extraction <i class="fas fa-arrow-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Feature Extraction Tab -->
                    <div class="tab-pane fade" id="features" role="tabpanel">
                        <div class="card mt-3">
                            <div class="card-body">
                                <h5 class="card-title">Feature Extraction
                                    <span class="electroml-tooltip">
                                        <span class="tooltip-icon important">?</span>
                                        <span class="tooltiptext feature-tooltip">
                                            <div class="tooltip-header">Converting Voltammograms to ML Features</div>
                                            <div>Extracts numerical descriptors from electrochemical signals:</div>
                                            <ul class="tooltip-list">
                                                <li>Peak characteristics (height, area, position)</li>
                                                <li>Statistical measures (mean, std, skewness)</li>
                                                <li>Signal quality metrics</li>
                                            </ul>
                                            <div class="tooltip-emphasis">Like peak integration in chromatography!</div>
                                        </span>
                                    </span>
                                </h5>
                                
                                <div class="row">
                                    <div class="col-md-4">
                                        <h6>Feature Extraction Settings</h6>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="extractStatistical" checked>
                                            <label class="form-check-label" for="extractStatistical">
                                                Statistical Features
                                                <span class="electroml-tooltip">
                                                    <span class="tooltip-icon">?</span>
                                                    <span class="tooltiptext">
                                                        <div>Mean, median, std dev, min, max, skewness, kurtosis</div>
                                                    </span>
                                                </span>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="extractPeak" checked>
                                            <label class="form-check-label" for="extractPeak">
                                                Peak Features
                                                <span class="electroml-tooltip">
                                                    <span class="tooltip-icon">?</span>
                                                    <span class="tooltiptext">
                                                        <div>Peak height, area, position, width (FWHM)</div>
                                                    </span>
                                                </span>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="extractFrequency">
                                            <label class="form-check-label" for="extractFrequency">
                                                Frequency Features
                                                <span class="electroml-tooltip">
                                                    <span class="tooltip-icon">?</span>
                                                    <span class="tooltiptext">
                                                        <div>FFT-based frequency domain features</div>
                                                    </span>
                                                </span>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="extractDerivative">
                                            <label class="form-check-label" for="extractDerivative">
                                                Derivative Features
                                                <span class="electroml-tooltip">
                                                    <span class="tooltip-icon">?</span>
                                                    <span class="tooltiptext">
                                                        <div>First and second derivative characteristics</div>
                                                    </span>
                                                </span>
                                            </label>
                                        </div>
                                        
                                        <h6 class="mt-3">Smoothing Options</h6>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="featureSmoothing" checked>
                                            <label class="form-check-label" for="featureSmoothing">
                                                Apply Smoothing
                                            </label>
                                        </div>
                                        <input type="number" class="form-control form-control-sm mt-2" 
                                               id="smoothWindow" placeholder="Window Length" value="11">
                                        <input type="number" class="form-control form-control-sm mt-2" 
                                               id="polyOrder" placeholder="Polynomial Order" value="3">
                                        
                                        <button class="btn btn-primary mt-3" onclick="extractFeatures()">
                                            <i class="fas fa-cogs"></i> Extract Features
                                        </button>
                                    </div>
                                    
                                    <div class="col-md-8">
                                        <div id="featureResults" style="display: none;">
                                            <h6>Feature Extraction Results</h6>
                                            <div class="alert alert-success">
                                                <i class="fas fa-check-circle"></i> 
                                                Extracted <span id="nExtractedFeatures"></span> features from 
                                                <span id="nExtractedSamples"></span> samples
                                            </div>
                                            
                                            <div id="featureImportancePlot"></div>
                                            <div id="featureImportanceDetails"></div>
                                            
                                            <button class="btn btn-success mt-3" onclick="proceedToTraining()">
                                                Proceed to Model Training <i class="fas fa-arrow-right"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Training Tab -->
                    <div class="tab-pane fade" id="training" role="tabpanel">
                        <div class="card mt-3">
                            <div class="card-body">
                                <h5 class="card-title">Model Training Configuration
                                    <span class="electroml-tooltip">
                                        <span class="tooltip-icon important">?</span>
                                        <span class="tooltiptext model-tooltip">
                                            <div class="tooltip-header">Machine Learning Training</div>
                                            <div>Train multiple algorithms to find best predictor:</div>
                                            <ul class="tooltip-list">
                                                <li>Linear models for calibration curves</li>
                                                <li>Tree ensembles for non-linearity</li>
                                                <li>Neural networks for complex patterns</li>
                                            </ul>
                                            <div class="tooltip-emphasis">Cross-validation ensures reliability!</div>
                                            <div class="tooltip-example">Random Forest often best for electrochemistry</div>
                                        </span>
                                    </span>
                                </h5>
                                
                                <div class="row">
                                    <!-- Model Selection -->
                                    <div class="col-md-4">
                                        <h6>Select Models
                                            <span class="electroml-tooltip">
                                                <span class="tooltip-icon">?</span>
                                                <span class="tooltiptext">
                                                    <div class="tooltip-header">ML Model Selection</div>
                                                    <div>Choose multiple models to compare performance:</div>
                                                    <ul class="tooltip-list">
                                                        <li><strong>Linear:</strong> Fast, interpretable baseline</li>
                                                        <li><strong>Tree-based:</strong> Handle non-linearity</li>
                                                        <li><strong>Neural:</strong> Complex patterns</li>
                                                    </ul>
                                                </span>
                                            </span>
                                        </h6>
                                        <div class="model-selection" style="max-height: 400px; overflow-y: auto;">
                                            <div class="form-check">
                                                <input class="form-check-input model-check" type="checkbox" 
                                                       value="linear_regression" id="linearReg" checked>
                                                <label class="form-check-label" for="linearReg">
                                                    Linear Regression
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input model-check" type="checkbox" 
                                                       value="ridge" id="ridge" checked>
                                                <label class="form-check-label" for="ridge">
                                                    Ridge Regression
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input model-check" type="checkbox" 
                                                       value="lasso" id="lasso">
                                                <label class="form-check-label" for="lasso">
                                                    Lasso Regression
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input model-check" type="checkbox" 
                                                       value="elastic_net" id="elasticNet">
                                                <label class="form-check-label" for="elasticNet">
                                                    Elastic Net
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input model-check" type="checkbox" 
                                                       value="svm" id="svm">
                                                <label class="form-check-label" for="svm">
                                                    Support Vector Machine
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input model-check" type="checkbox" 
                                                       value="random_forest" id="rf" checked>
                                                <label class="form-check-label" for="rf">
                                                    Random Forest
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input model-check" type="checkbox" 
                                                       value="gradient_boosting" id="gb">
                                                <label class="form-check-label" for="gb">
                                                    Gradient Boosting
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input model-check" type="checkbox" 
                                                       value="mlp" id="mlp">
                                                <label class="form-check-label" for="mlp" title="Optimized MLP for small datasets with LBFGS solver">
                                                    MLP (Small Data Optimized)
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input model-check" type="checkbox" 
                                                       value="neural_network" id="nn">
                                                <label class="form-check-label" for="nn" title="Deeper neural network with Adam optimizer">
                                                    Neural Network (Deep)
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Cross-Validation Strategy -->
                                    <div class="col-md-3">
                                        <h6>Cross-Validation Strategy
                                            <span class="electroml-tooltip">
                                                <span class="tooltip-icon">?</span>
                                                <span class="tooltiptext">
                                                    <div class="tooltip-header">Model Validation Method</div>
                                                    <div>Prevents overfitting by testing on unseen data:</div>
                                                    <ul class="tooltip-list">
                                                        <li><strong>K-Fold:</strong> Splits data into k parts</li>
                                                        <li><strong>LOO:</strong> Tests each sample individually</li>
                                                        <li><strong>Time Series:</strong> Respects temporal order</li>
                                                    </ul>
                                                    <div class="tooltip-emphasis">LOO best for n < 50 samples</div>
                                                </span>
                                            </span>
                                        </h6>
                                        <select class="form-select" id="cvStrategy">
                                            <option value="loo" selected title="Each sample tested individually - gold standard for small datasets">Leave-One-Out (Recommended)</option>
                                            <option value="kfold" title="Splits data into k equal parts, trains on k-1, tests on 1">K-Fold</option>
                                            <option value="stratified_kfold" title="K-Fold maintaining concentration distribution">Stratified K-Fold</option>
                                            <option value="time_series" title="For time-dependent data like sensor degradation studies">Time Series Split</option>
                                            <option value="train_test_split">Train/Test Split</option>
                                        </select>
                                        
                                        <div class="mt-2" id="cvParams">
                                            <label for="nSplits" class="form-label">Number of Splits
                                                <span class="electroml-tooltip">
                                                    <span class="tooltip-icon">?</span>
                                                    <span class="tooltiptext">
                                                        <div class="tooltip-header">K-Fold Splits</div>
                                                        <div>Number of data partitions for cross-validation</div>
                                                        <div class="tooltip-emphasis">5 is standard, use 10 for larger datasets</div>
                                                    </span>
                                                </span>
                                            </label>
                                            <input type="number" class="form-control" id="nSplits" value="5" min="2" max="10">
                                            
                                            <label for="testSize" class="form-label mt-2">Test Size
                                                <span class="electroml-tooltip">
                                                    <span class="tooltip-icon">?</span>
                                                    <span class="tooltiptext">
                                                        <div class="tooltip-header">Test Set Proportion</div>
                                                        <div>Fraction of data reserved for testing (0.2 = 20%)</div>
                                                        <div class="tooltip-emphasis">80/20 split is standard practice</div>
                                                    </span>
                                                </span>
                                            </label>
                                            <input type="number" class="form-control" id="testSize" value="0.2" min="0.1" max="0.5" step="0.1">
                                        </div>
                                        
                                        <div class="form-check mt-2">
                                            <input class="form-check-input" type="checkbox" id="shuffleData">
                                            <label class="form-check-label" for="shuffleData">
                                                Shuffle Data
                                                <span class="electroml-tooltip">
                                                    <span class="tooltip-icon">?</span>
                                                    <span class="tooltiptext">
                                                        <div class="tooltip-header">Random Shuffling</div>
                                                        <div>Randomize sample order before splitting</div>
                                                        <div class="tooltip-emphasis">Essential unless time-dependent!</div>
                                                    </span>
                                                </span>
                                            </label>
                                        </div>
                                        
                                        <label for="randomSeed" class="form-label mt-2">Random Seed
                                            <span class="electroml-tooltip">
                                                <span class="tooltip-icon">?</span>
                                                <span class="tooltiptext">
                                                    <div class="tooltip-header">Reproducibility Seed</div>
                                                    <div>Fixed seed ensures same results each run</div>
                                                    <div class="tooltip-example">Use 42 for reproducible research</div>
                                                </span>
                                            </span>
                                        </label>
                                        <input type="number" class="form-control" id="randomSeed" value="42">
                                    </div>
                                    
                                    <!-- Hyperparameter Tuning -->
                                    <div class="col-md-3">
                                        <h6>Hyperparameter Tuning
                                            <span class="electroml-tooltip">
                                                <span class="tooltip-icon">?</span>
                                                <span class="tooltiptext">
                                                    <div class="tooltip-header">Automatic Optimization</div>
                                                    <div>Finds best model settings automatically:</div>
                                                    <ul class="tooltip-list">
                                                        <li>Learning rate, tree depth, regularization</li>
                                                        <li>Like optimizing instrument parameters</li>
                                                    </ul>
                                                    <div class="tooltip-emphasis">Improves accuracy 10-30%</div>
                                                    <div class="tooltip-example">Takes 5-30 min depending on data</div>
                                                </span>
                                            </span>
                                        </h6>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="hyperparamTuning">
                                            <label class="form-check-label" for="hyperparamTuning">
                                                Enable Hyperparameter Tuning
                                                <span class="electroml-tooltip">
                                                    <span class="tooltip-icon">?</span>
                                                    <span class="tooltiptext">
                                                        <div>Automatically optimize model parameters</div>
                                                        <div class="tooltip-emphasis">Recommended for final models</div>
                                                    </span>
                                                </span>
                                            </label>
                                        </div>
                                        
                                        <select class="form-select mt-2" id="searchType" title="Search strategy for optimization">
                                            <option value="grid" title="Tests all parameter combinations - thorough but slow">Grid Search</option>
                                            <option value="random" title="Random sampling - faster, often as good">Random Search</option>
                                        </select>
                                        
                                        <button class="btn btn-sm btn-secondary mt-2" onclick="showHyperparamConfig()">
                                            <i class="fas fa-cog"></i> Configure Parameters
                                        </button>
                                    </div>
                                    
                                    <!-- Advanced Options -->
                                    <div class="col-md-3">
                                        <h6>Advanced Options</h6>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="featureSelection">
                                            <label class="form-check-label" for="featureSelection">
                                                Feature Selection
                                            </label>
                                        </div>
                                        
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="ensembleModels">
                                            <label class="form-check-label" for="ensembleModels">
                                                Create Ensemble
                                            </label>
                                        </div>
                                        
                                        <select class="form-select mt-2" id="ensembleType">
                                            <option value="voting">Voting</option>
                                            <option value="stacking">Stacking</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <button class="btn btn-primary" onclick="trainModels()">
                                            <i class="fas fa-play"></i> Start Training
                                        </button>
                                        <div id="trainingProgress" class="mt-3" style="display: none;">
                                            <div class="progress">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                                     role="progressbar" style="width: 100%">
                                                    Training Models...
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="trainingResults" class="mt-3" style="display: none;">
                                    <h6>Training Results</h6>
                                    <table class="table table-striped" id="resultsTable">
                                        <thead>
                                            <tr>
                                                <th>Model</th>
                                                <th>RÂ² Score
                                                    <span class="electroml-tooltip">
                                                        <span class="tooltip-icon">?</span>
                                                        <span class="tooltiptext metric-tooltip">
                                                            <div class="tooltip-header">Coefficient of Determination</div>
                                                            <div>Proportion of variance explained (0-1)</div>
                                                            <ul class="tooltip-list">
                                                                <li>1.0 = Perfect prediction</li>
                                                                <li>0.95+ = Excellent</li>
                                                                <li>0.90+ = Very good</li>
                                                                <li>0.80+ = Good</li>
                                                                <li><0.5 = Poor</li>
                                                            </ul>
                                                            <div class="tooltip-formula">RÂ² = 1 - (SS_res/SS_tot)</div>
                                                            <div class="tooltip-emphasis">Higher is better!</div>
                                                        </span>
                                                    </span>
                                                </th>
                                                <th>RMSE
                                                    <span class="electroml-tooltip">
                                                        <span class="tooltip-icon">?</span>
                                                        <span class="tooltiptext metric-tooltip">
                                                            <div class="tooltip-header">Root Mean Square Error</div>
                                                            <div>Average prediction error in Î¼M</div>
                                                            <div class="tooltip-formula">RMSE = â(Î£(actual-predicted)Â²/n)</div>
                                                            <ul class="tooltip-list">
                                                                <li>Same units as concentration</li>
                                                                <li>Sensitive to outliers</li>
                                                            </ul>
                                                            <div class="tooltip-emphasis">Lower is better!</div>
                                                            <div class="tooltip-example">RMSE=0.5Î¼M means Â±0.5Î¼M average error</div>
                                                        </span>
                                                    </span>
                                                </th>
                                                <th>MAE
                                                    <span class="electroml-tooltip">
                                                        <span class="tooltip-icon">?</span>
                                                        <span class="tooltiptext metric-tooltip">
                                                            <div class="tooltip-header">Mean Absolute Error</div>
                                                            <div>Average absolute prediction error in Î¼M</div>
                                                            <div class="tooltip-formula">MAE = Î£|actual-predicted|/n</div>
                                                            <ul class="tooltip-list">
                                                                <li>More robust to outliers than RMSE</li>
                                                                <li>Easier to interpret</li>
                                                            </ul>
                                                            <div class="tooltip-emphasis">Lower is better!</div>
                                                            <div class="tooltip-example">MAE=0.3Î¼M means average Â±0.3Î¼M error</div>
                                                        </span>
                                                    </span>
                                                </th>
                                                <th>CV Score
                                                    <span class="electroml-tooltip">
                                                        <span class="tooltip-icon">?</span>
                                                        <span class="tooltiptext metric-tooltip">
                                                            <div class="tooltip-header">Cross-Validation Score</div>
                                                            <div>Average RÂ² across all CV folds</div>
                                                            <div class="tooltip-emphasis">More reliable than single train/test</div>
                                                            <div class="tooltip-example">Shows model consistency</div>
                                                        </span>
                                                    </span>
                                                </th>
                                                <th>Training Time
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                    
                                    <!-- Predicted vs Actual Section -->
                                    <div class="mt-4">
                                        <h6>Model Performance Visualization
                                            <span class="electroml-tooltip">
                                                <span class="tooltip-icon">?</span>
                                                <span class="tooltiptext">
                                                    <div class="tooltip-header">Performance Analysis</div>
                                                    <div>Visual comparison of predicted vs actual concentrations</div>
                                                    <div class="tooltip-emphasis">Points close to diagonal = good predictions</div>
                                                </span>
                                            </span>
                                        </h6>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <!-- Scatter Plot -->
                                                <div id="actualVsPredictedPlot"></div>
                                            </div>
                                            <div class="col-md-6">
                                                <!-- Residuals Plot -->
                                                <div id="residualsPlot"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Predicted vs Actual Table -->
                                        <div class="mt-3">
                                            <h6>Predicted vs Actual Values
                                                <button class="btn btn-sm btn-secondary float-end" onclick="exportPredictions()">
                                                    <i class="fas fa-download"></i> Export
                                                </button>
                                            </h6>
                                            <div style="max-height: 300px; overflow-y: auto;">
                                                <table class="table table-sm table-hover" id="predictedActualTable">
                                                    <thead class="sticky-top bg-white">
                                                        <tr>
                                                            <th>Sample #</th>
                                                            <th>Actual (Î¼M)</th>
                                                            <th>Predicted (Î¼M)</th>
                                                            <th>Error (Î¼M)</th>
                                                            <th>Error (%)</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody></tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Prediction Tab -->
                    <div class="tab-pane fade" id="prediction" role="tabpanel">
                        <div class="card mt-3">
                            <div class="card-body">
                                <h5 class="card-title">Prediction
                                    <span class="electroml-tooltip">
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltiptext">
                                            <div class="tooltip-header">Concentration Prediction</div>
                                            <div>Use your trained models to predict unknown sample concentrations</div>
                                            <ul class="tooltip-list">
                                                <li>Upload new sensor data files</li>
                                                <li>Apply same preprocessing as training</li>
                                                <li>Get predicted concentrations in Î¼M</li>
                                                <li>Export results for reporting</li>
                                            </ul>
                                            <div class="tooltip-emphasis">This replaces traditional calibration curves!</div>
                                        </span>
                                    </span>
                                </h5>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Prediction Mode</h6>
                                        <div class="btn-group" role="group">
                                            <input type="radio" class="btn-check" name="predMode" id="modeFile" checked>
                                            <label class="btn btn-outline-primary" for="modeFile">
                                                <i class="fas fa-file"></i> Upload File
                                            </label>
                                            
                                            <input type="radio" class="btn-check" name="predMode" id="modeManual">
                                            <label class="btn btn-outline-primary" for="modeManual">
                                                <i class="fas fa-keyboard"></i> Manual Entry
                                            </label>
                                            
                                            <input type="radio" class="btn-check" name="predMode" id="modeValidation">
                                            <label class="btn btn-outline-primary" for="modeValidation">
                                                <i class="fas fa-check-double"></i> Validation Set
                                            </label>
                                        </div>
                                        
                                        <div id="fileUploadSection" class="mt-3">
                                            <label for="predFileInput" class="form-label">Upload Test Data</label>
                                            <input type="file" class="form-control" id="predFileInput" accept=".csv,.xlsx,.xls">
                                        </div>
                                        
                                        <div id="manualEntrySection" class="mt-3" style="display: none;">
                                            <label class="form-label">Enter Test Data</label>
                                            <textarea class="form-control" id="manualData" rows="5" 
                                                    placeholder="Enter data in CSV format"></textarea>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <label for="modelSelect" class="form-label">Select Model</label>
                                            <select class="form-select" id="modelSelect"></select>
                                        </div>
                                        
                                        <div class="form-check mt-2">
                                            <input class="form-check-input" type="checkbox" id="applyPreprocessingToPred" checked>
                                            <label class="form-check-label" for="applyPreprocessingToPred">
                                                Apply same preprocessing as training
                                            </label>
                                        </div>
                                        
                                        <button class="btn btn-primary mt-3" onclick="makePredictions()">
                                            <i class="fas fa-chart-line"></i> Make Predictions
                                        </button>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div id="predictionResults" style="display: none;">
                                            <h6>Prediction Results</h6>
                                            <div id="predictionStats"></div>
                                            <div id="predictionPlot"></div>
                                            <button class="btn btn-success mt-2" onclick="downloadPredictions()">
                                                <i class="fas fa-download"></i> Download Results
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Visualization Tab -->
                    <div class="tab-pane fade" id="visualization" role="tabpanel">
                        <div class="card mt-3">
                            <div class="card-body">
                                <h5 class="card-title">Publication-Ready Visualizations
                                    <span class="electroml-tooltip">
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltiptext">
                                            <div class="tooltip-header">Scientific Plotting</div>
                                            <div>Create professional figures for papers and presentations</div>
                                            <ul class="tooltip-list">
                                                <li><strong>Voltammograms:</strong> Plot sensor signals</li>
                                                <li><strong>Model Comparison:</strong> Compare ML model performance</li>
                                                <li><strong>Feature Importance:</strong> Show which features matter most</li>
                                                <li><strong>Multi-Panel:</strong> Combine multiple plots</li>
                                            </ul>
                                            <div class="tooltip-emphasis">Export in journal-ready formats!</div>
                                            <div class="tooltip-example">Supports PNG, SVG, PDF for publications</div>
                                        </span>
                                    </span>
                                </h5>
                                
                                <div class="row">
                                    <!-- Plot Type Selection -->
                                    <div class="col-md-3">
                                        <h6>Plot Type</h6>
                                        <select class="form-select" id="plotType">
                                            <option value="voltammogram">Voltammogram</option>
                                            <option value="scatter">Scatter Plot</option>
                                            <option value="bar">Bar Chart</option>
                                            <option value="heatmap">Heatmap</option>
                                            <option value="multi_panel">Multi-Panel Figure</option>
                                            <option value="model_comparison">Model Comparison</option>
                                            <option value="feature_importance">Feature Importance</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Plot Customization -->
                                    <div class="col-md-9">
                                        <h6>Customization Options</h6>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label class="form-label">Title</label>
                                                <input type="text" class="form-control" id="plotTitle">
                                                
                                                <label class="form-label mt-2">X-Axis Label</label>
                                                <input type="text" class="form-control" id="xLabel" value="Voltage (V)">
                                                
                                                <label class="form-label mt-2">Y-Axis Label</label>
                                                <input type="text" class="form-control" id="yLabel" value="Current (A)">
                                            </div>
                                            
                                            <div class="col-md-4">
                                                <label class="form-label">Color Scheme</label>
                                                <select class="form-select" id="colorScheme">
                                                    <option value="default">Default</option>
                                                    <option value="colorblind">Colorblind-Friendly</option>
                                                    <option value="grayscale">Grayscale</option>
                                                </select>
                                                
                                                <label class="form-label mt-2">Font Family</label>
                                                <select class="form-select" id="fontFamily">
                                                    <option value="Arial">Arial</option>
                                                    <option value="Times New Roman">Times New Roman</option>
                                                    <option value="Helvetica">Helvetica</option>
                                                    <option value="Computer Modern">Computer Modern (LaTeX)</option>
                                                </select>
                                                
                                                <label class="form-label mt-2">Font Size</label>
                                                <input type="number" class="form-control" id="fontSize" value="12" min="8" max="24">
                                            </div>
                                            
                                            <div class="col-md-4">
                                                <label class="form-label">Figure Width (inches)</label>
                                                <input type="number" class="form-control" id="figWidth" value="10" min="4" max="20">
                                                
                                                <label class="form-label mt-2">Figure Height (inches)</label>
                                                <input type="number" class="form-control" id="figHeight" value="6" min="3" max="15">
                                                
                                                <label class="form-label mt-2">DPI (for export)</label>
                                                <input type="number" class="form-control" id="dpi" value="300" min="72" max="600" step="50">
                                            </div>
                                        </div>
                                        
                                        <div class="row mt-3">
                                            <div class="col-12">
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="showGrid" checked>
                                                    <label class="form-check-label" for="showGrid">Show Grid</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="showLegend" checked>
                                                    <label class="form-check-label" for="showLegend">Show Legend</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="checkbox" id="showTrendline">
                                                    <label class="form-check-label" for="showTrendline">Show Trendline</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <button class="btn btn-primary" onclick="createPlot()">
                                            <i class="fas fa-chart-area"></i> Generate Plot
                                        </button>
                                        
                                        <div class="btn-group ms-2" role="group">
                                            <button class="btn btn-success" onclick="exportPlot('png')">
                                                <i class="fas fa-file-image"></i> PNG
                                            </button>
                                            <button class="btn btn-success" onclick="exportPlot('svg')">
                                                <i class="fas fa-file-code"></i> SVG
                                            </button>
                                            <button class="btn btn-success" onclick="exportPlot('pdf')">
                                                <i class="fas fa-file-pdf"></i> PDF
                                            </button>
                                            <button class="btn btn-success" onclick="exportPlot('html')">
                                                <i class="fas fa-file-code"></i> HTML
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="plotContainer" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ElectroML Help Guide</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>Workflow Overview</h6>
                    <ol>
                        <li><strong>Data Upload:</strong> Upload CSV or Excel files with concentration and measurement data</li>
                        <li><strong>Preprocessing:</strong> Apply outlier removal, baseline correction, filtering, and normalization</li>
                        <li><strong>Feature Extraction:</strong> Extract statistical, peak, and frequency features</li>
                        <li><strong>Model Training:</strong> Train multiple ML models with configurable cross-validation</li>
                        <li><strong>Prediction:</strong> Make predictions on new data with multiple input options</li>
                        <li><strong>Visualization:</strong> Create publication-ready plots with extensive customization</li>
                    </ol>
                    
                    <h6>Data Format</h6>
                    <p>First column: Concentration values (Î¼M)<br>
                    Remaining columns: Current measurements at different voltages</p>
                    
                    <h6>Tips</h6>
                    <ul>
                        <li>Use Leave-One-Out CV for small datasets (&lt;10 samples)</li>
                        <li>Enable hyperparameter tuning for better model performance</li>
                        <li>Export plots in SVG format for publications</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Hyperparameter Configuration Modal -->
    <div class="modal fade" id="hyperparamModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Hyperparameter Configuration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="hyperparamBody">
                    <!-- Dynamic content based on selected models -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveHyperparams()">Save Configuration</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Tooltip System JS -->
    <script src="{{ url_for('static', filename='js/tooltips.js') }}"></script>
    <!-- Enhanced Application JS -->
    <script src="{{ url_for('static', filename='js/app_enhanced.js') }}"></script>
</body>
</html>